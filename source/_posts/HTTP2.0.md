---
title: HTTP2.0
---

你应该了解的HTTP2.0~
<!-- more -->

## HTTP1.1存在的问题

现在我们先不聊HTTP2, 看一下HTTP发展到1.1存在有哪些问题：

1. **线头阻塞：**TCP连接上只能发送一个请求，前面的请求未完成前，后续的请求都在排队等待。
2. **多个TCP连接：**虽然HTTP/1.1管线化可以支持请求并发，但是浏览器很难实现，chrome、firefox等都禁用了管线化。所以1.1版本请求并发依赖于多个TCP连接，建立TCP连接成本很高，还会存在慢启动的问题。
3. **头部冗余，采用文本格式：**HTTP/1.X版本是采用文本格式，首部未压缩，而且每一个请求都会带上cookie、user-agent等完全相同的首部。
4. **客户端需要主动请求**

## HTTP2.0新特性

### 二进制分帧

#### 什么是二进制分帧

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/9/16792b2d88c55af5~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

在二进制分帧层上，HTTP2.0会将所有传输信息分割为更小的消息和帧，并对它们采用二进制格式的编码将其封装。其中，HTTP1.X中的首部信息header封装到Headers帧中，而request body将被封装到Data帧中。

#### 二进制分帧如何工作

HTTP2.0通信都在一个TCP连接上完成，这个连接可以承载**任意数量的双向数据流**，相应的每个数据流以**消息的形式**发送。而消息由一或多个帧组成，这些帧可以乱序发送，然后根据每个帧首部的流标识符重新组装。

#### 二进制分帧对性能优化工作的贡献

二进制分帧主要是为下文中的各种特性提供了基础。它能把一个数据划分封装为更小更便捷的数据。首先是在单链接多资源方式中，减少了服务端的链接压力，内存占用更少，链接吞吐量更大。另一方面，由于**TCP链接的减少而使网络拥塞状态得以改善**，同时慢启动时间的减少。使拥塞和丢包恢复的速度更快

### 首部压缩

HTTP1.1并不支持HTTP首部压缩，为此SPDY和HTTP2.0出现了。SPDY是用的是DEFLATE算法，而HTTP2.0则使用了专门为首部压缩设计的**HPACK算法**。

#### 什么是首部压缩

HTTP1.x每次通讯（请求或响应）都会携带首部信息用于描述资源属性。而HTTP2.0在客户端和服务端之间使用**首部表**来跟踪和存储之前发送的键值对。请求与响应首部的定义在HTTP2.0中基本没有变，只是所有首部键必须全部小写。

#### 首部压缩如何工作

对于相同的数据，不再重新通过每次请求和响应发送。每个新的首部键值对要么追加到当前表的末尾，要么替换表中之前的值。首部表在HTTP2.0的链接存续期内始终存在，由客户端和服务端共同渐进的更新。

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/1/5/160c570596a277bf~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)



#### 首部压缩性能优化工作的贡献

首部表在HTTP2.0使用了首部压缩的技术。使报头更紧凑，更快速传输，有利于移动网络环境。减少每次通讯的数据量，使网络拥塞状态得以改善。

### 多路复用

在**HTTP1.1**中，浏览器客户端在同一时间，针对**同一域名下的请求有一定数量的限制**。超过限制数目的请求会被阻塞。而HTTP2.0中的多路复用优化了这一性能。

#### 什么是多路复用

**基于二进制分帧层**，HTTP2.0可以在共享TCP链接的基础上同时发送请求和响应。**HTTP消息被分解为独立的帧**，而不破坏消息本身的语义，交错发出去，在另一端根据**流标识符**和**首部**将他们重新组装起来。

#### 多路复用如何工作

我们来通过与HTTP1.X的对比来看看他是如何工作的。

- HTTP1.x

  ![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/1/5/160c5b5d678210bb~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

- HTTP2.0

  ![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/1/5/160c5b6a596f82fe~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

#### 多路复用对性能优化工作的贡献

1. 可以并行交错的发送请求和响应，这些请求和响应之间互不影响
2. 只使用一个链接即可并行发送多个请求和响应
3. 消除不必要的延迟，从而减少页面加载的时间
4. 不必再为绕过HTTP1.x限制而多做很多工作

### 服务器端推送

HTTP2还在一定程度上改变了传统的“请求-应答”工作模式，服务器不再是完全被动地响应请求，也可以新建“流”主动向客户端发送消息。这被称为"服务器推送"（Server Push）

例如下图所示,服务端主动把JS和CSS文件推送给客户端，而不需要客户端解析HTML时再发送这些请求。

![img](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/2/28/16934a8dd0ad7485~tplv-t2oaga2asx-zoom-in-crop-mark:1304:0:0:0.awebp)

另外需要补充的是,服务端可以主动推送，客户端也有权利选择是否接收。如果服务端推送的资源已经被浏览器缓存过，浏览器可以通过发送RST_STREAM帧来拒收。主动推送也遵守同源策略，换句话说，服务器不能随便将第三方资源推送给客户端，而必须是经过双方确认才行。

### 请求优先级

把HTTP消息分为很多独立帧之后，就可以通过优化这些帧的交错和传输顺序进一步优化性能。

#### 什么是请求优先级

每个流都可以带有一个31bit的优先值：0表示最高优先级；2的31次方-1表示最低优先级。

客户端明确指定优先级，服务端可以根据这个优先级作为交互数据的依据，比如客户端优先设置为.css>.js>.jpg。

## HTTP/1 的几种优化可以弃用

**合并文件、内联资源、雪碧图、域名分片**对于 HTTP/2 来说是不必要的，使用 h2 尽可能将资源细粒化，文件分解地尽可能散，不用担心请求数多